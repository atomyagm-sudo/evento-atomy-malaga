<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Portrait AI - Generador de Estilos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-upload-card {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        .file-upload-card.drag-over {
            border-color: #667eea;
            background-color: #f0f2ff;
        }
        .preview-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
        }
        #dog-previews-container .preview-image {
            width: 80px;
            height: 80px;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom Modal for alerts */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 90%;
            width: 400px;
            text-align: center;
        }
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            justify-items: center;
        }
        .sticker-container {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            border-radius: 0.5rem;
            text-align: center;
            background-color: #fafafa;
        }
        .sticker-container img {
            width: 100%;
            height: auto;
            max-height: 100px;
            object-fit: contain;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="bg-gradient-to-r from-blue-50 to-purple-50 min-h-screen">
    <div class="container mx-auto p-4 md:p-8">
        
        <!-- HEADER -->
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">
                üêæ Pet Portrait AI
            </h1>
            <div class="inline-block bg-purple-100 text-purple-800 text-sm font-semibold mt-2 px-3 py-1 rounded-full">
                Impulsado por Gemini 2.5 (Nano Banana)
            </div>
            <p class="text-lg md:text-xl text-gray-600 mt-3">Transforma tus momentos con mascotas en obras de arte</p>
        </header>

        <!-- MAIN LAYOUT: Inputs (Left) vs. Results (Right) -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">

            <!-- COLUMNA DE ENTRADAS Y CONTROLES -->
            <div class="space-y-8">
                
                <!-- 1. Sube tu Foto (Selfie) -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center gap-2">1. Sube tu Foto üë§</h2>
                    <div id="selfie-drop-area" class="file-upload-card p-6 text-center rounded-lg cursor-pointer">
                        <input type="file" id="selfie-input" accept="image/png, image/jpeg, image/webp" class="hidden">
                        <div class="text-gray-500">
                            <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <p class="mt-2 text-lg font-medium">+ Sube tu selfie</p>
                            <p class="text-xs text-gray-400 mt-1">Arrastra y suelta o haz clic aqu√≠</p>
                        </div>
                    </div>
                    <div id="selfie-preview-container" class="mt-4 hidden">
                        <p class="font-medium text-sm text-gray-600 mb-2">Vista Previa:</p>
                        <div id="selfie-preview" class="flex justify-center"></div>
                    </div>
                </div>

                <!-- 2. Sube fotos de la Mascota -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center gap-2">2. Sube sus Fotos üêï</h2>
                    <div id="dogs-drop-area" class="file-upload-card p-6 text-center rounded-lg cursor-pointer">
                        <input type="file" id="dogs-input" accept="image/png, image/jpeg, image/webp" multiple class="hidden">
                        <div class="text-gray-500">
                           <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
                            <p class="mt-2 text-lg font-medium">+ Sube fotos de tus perros</p>
                            <p class="text-xs text-gray-400 mt-1">Puedes seleccionar m√∫ltiples archivos</p>
                        </div>
                    </div>
                    <div id="dogs-previews-container" class="mt-4 hidden">
                        <p class="font-medium text-sm text-gray-600 mb-2">Vistas Previas:</p>
                        <div id="dog-previews" class="flex flex-wrap gap-3 justify-center"></div>
                    </div>
                </div>
                
                <!-- 3. Elige el Estilo -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center gap-2">3. Elige el Estilo Art√≠stico üé®</h2>
                    <p class="text-sm text-gray-600 mb-3">La composici√≥n ser√° de cabezas apiladas y mirando a c√°mara.</p>
                    <label for="style-select" class="block text-sm font-medium text-gray-700 mb-2">Selecciona un Estilo:</label>
                    <select id="style-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 bg-gray-50">
                        <!-- Opciones de estilos se llenar√°n con JS -->
                    </select>
                    <div id="style-details" class="mt-3 text-sm text-gray-500 p-3 bg-gray-100 rounded-lg">
                        Alta resoluci√≥n, emotivo, minimalista.
                    </div>
                </div>

                <!-- 4. Bot√≥n de Generaci√≥n -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center gap-2">4. ¬°Crea la Magia! ‚ú®</h2>
                    <button id="generate-btn" class="w-full bg-gradient-to-r from-[#667eea] to-[#764ba2] text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-300">
                        üé® Crear Mi Retrato
                    </button>
                </div>
            </div>

            <!-- COLUMNA DE ESTADO Y RESULTADOS (Simplificada) -->
            <div>
                
                <!-- ESTADO DE CARGA/MENSAJE -->
                <div id="message-column" class="hidden bg-white p-6 rounded-xl shadow-lg text-center flex flex-col justify-center items-center min-h-[400px]">
                    <div id="loader" class="loader mb-4"></div>
                    <h3 id="message-title" class="text-xl font-bold text-gray-800">Generando tu obra de arte...</h3>
                    <p id="message-text" class="text-gray-600 mt-2">La IA est√° trabajando su magia. Esto puede tardar un momento...</p>
                </div>

                <!-- RESULTADOS (IMAGEN + STICKERS + CONTROLES) -->
                <div id="result-column" class="hidden bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4" id="result-title">üéâ ¬°Tu Retrato Est√° Listo!</h2>
                    
                    <!-- 1. √Årea de la Imagen Principal -->
                    <div id="portrait-result-section" class="mb-6">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3">Retrato Art√≠stico Principal</h3>
                        <!-- Contenedor de la Imagen -->
                        <div class="w-full aspect-video bg-gray-100 flex items-center justify-center rounded-lg shadow-inner border border-gray-300 overflow-hidden">
                             <img id="result-image" src="" alt="Retrato generado por IA" class="w-full h-auto object-cover">
                        </div>
                        
                        <button id="download-btn" class="w-full mt-4 bg-green-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-600 transition-all duration-300">
                            ‚¨áÔ∏è Descargar Retrato Principal
                        </button>
                    </div>

                    <!-- 2. √Årea para los Stickers/Pegatinas -->
                    <div id="sticker-result-section" class="mt-6 pt-4 border-t border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3">Tu Set de Stickers Personalizado</h3>
                        <button id="generate-sticker-btn" class="w-full bg-pink-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-pink-600 transition-all duration-300 mb-3">
                            ‚ú® Generar Stickers
                        </button>
                        
                        <!-- Contenedor donde se insertar√°n los stickers generados -->
                        <div id="sticker-list" class="sticker-grid">
                            <p class="text-gray-500 text-sm italic col-span-full" id="sticker-placeholder">
                                Haz clic en "Generar Stickers" para crear un set de pegatinas de tus personajes.
                            </p>
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-4 hidden" id="sticker-note">Nota: Haz clic en "Descargar" en cada sticker para obtener la versi√≥n PNG con fondo transparente/blanco.</p>
                    </div>

                    <!-- Botones de Acci√≥n -->
                    <div class="mt-6 pt-4 border-t border-gray-200 space-y-3">
                        <button id="regenerate-btn" class="w-full bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-600 transition-all duration-300">
                            üîÑ Regenerar Retrato (Mismas Fotos)
                        </button>
                        <button id="start-over-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-all duration-300">
                            Empezar de Nuevo
                        </button>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert" class="modal-backdrop hidden">
        <div class="modal-content">
            <p id="alert-message" class="text-gray-700 mb-6"></p>
            <button id="alert-close-btn" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition-colors">Entendido</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- VARIABLES DE ELEMENTOS ---
            const selfieDropArea = document.getElementById('selfie-drop-area');
            const selfieInput = document.getElementById('selfie-input');
            const selfiePreviewContainer = document.getElementById('selfie-preview-container');
            const selfiePreview = document.getElementById('selfie-preview');

            const dogsDropArea = document.getElementById('dogs-drop-area');
            const dogsInput = document.getElementById('dogs-input');
            const dogsPreviewsContainer = document.getElementById('dogs-previews-container');
            const dogPreviews = document.getElementById('dog-previews');
            
            const styleSelect = document.getElementById('style-select');
            const styleDetails = document.getElementById('style-details');
            
            const generateBtn = document.getElementById('generate-btn');
            const generateStickerBtn = document.getElementById('generate-sticker-btn'); 
            
            const messageCol = document.getElementById('message-column');
            const resultCol = document.getElementById('result-column');
            
            const resultImage = document.getElementById('result-image');
            const stickerList = document.getElementById('sticker-list'); 
            const stickerPlaceholder = document.getElementById('sticker-placeholder');
            const stickerNote = document.getElementById('sticker-note');
            
            const startOverBtn = document.getElementById('start-over-btn');
            const downloadBtn = document.getElementById('download-btn');
            const regenerateBtn = document.getElementById('regenerate-btn'); 

            const customAlert = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('alert-message');
            const alertCloseBtn = document.getElementById('alert-close-btn');
            
            let selfieFile = null;
            let dogFiles = [];
            let loadingInterval = null;
            let currentMode = 'portrait'; 
            let currentPortraitUrl = '';
            
            // --- DEFINICI√ìN DE ESTILOS (ACTUALIZADOS) ---
            const styles = {
                'fine_art_bw': {
                    name: 'Fine Art Blanco y Negro üñºÔ∏è',
                    description: `black and white fine art portrait of a person resting their head on a soft couch, with one or more dogs with their heads stacked one on top of the other, gently leaning on the person‚Äôs head and shoulder, creating an intimate, calm, emotional composition. Soft natural window light, shallow depth of field, cinematic mood, high-resolution photo with fine skin detail and visible dog fur texture, neutral background out of focus (bokeh). All subjects looking directly into the camera lens. Shot on a professional camera (Canon RF 50mm f/1.2 or similar). Moody, editorial style, minimal distractions, focus on the emotional bond between human and pets.`,
                    details: 'Retrato de estudio en B/N, alta calidad, luz suave.'
                },
                'watercolor': {
                    name: 'Acuarela Suave üé®',
                    description: `soft watercolor portrait of a person resting their head on a soft couch, with one or more dogs with their heads stacked one on top of the other, gently leaning on the person‚Äôs head and shoulder, creating an intimate, calm, emotional composition. Pastel color palette, light paper texture, ethereal mood, shallow depth of field, detailed watercolor strokes. All subjects looking directly into the camera lens.`,
                    details: 'Colores pastel, bordes suaves, sensaci√≥n pintada.'
                },
                'oil_painting': {
                    name: 'Pintura al √ìleo Cl√°sica üñåÔ∏è',
                    description: `classic oil painting portrait of a person resting their head on a soft couch, with one or more dogs with their heads stacked one on top of the other, gently leaning on the person‚Äôs head and shoulder, creating an intimate, calm, emotional composition. Rich, warm colors, visible impasto brushstrokes, golden hour lighting, deep depth of field, dramatic chiaroscuro. All subjects looking directly into the camera lens.`,
                    details: 'Colores ricos, pinceladas visibles, luz dram√°tica.'
                },
                'charcoal_sketch': {
                    name: 'Boceto a Carboncillo ‚úèÔ∏è',
                    description: `realistic charcoal sketch on textured paper of a person resting their head on a soft couch, with one or more dogs with their heads stacked. Dramatic shading, highly detailed texture of charcoal and paper, high-contrast black and white. All subjects looking directly into the camera lens.`,
                    details: 'Boceto dram√°tico, texturas detalladas de carb√≥n, alto contraste B/N.'
                },
                'anime_manga': {
                    name: 'Anime Japon√©s üéå',
                    description: `vibrant Japanese anime style portrait of a person resting their head on a soft couch, with one or more dogs with their heads stacked one on top of the other, gently leaning on the person‚Äôs head and shoulder, creating an intimate, calm, emotional composition. Large, expressive eyes, dynamic lighting, clean line work, vibrant cell-shading, soft focus background, cinematic composition. All subjects looking directly into the camera lens.`,
                    details: 'L√≠neas limpias, colores brillantes, ojos grandes y expresivos.'
                },
                'ghibli_studio': {
                    name: 'Estilo Studio Ghibli üçÉ',
                    description: `hand-drawn, warm, and whimsical Studio Ghibli-inspired animation style portrait of a person resting their head on a soft couch, with one or more dogs with their heads stacked one on top of the other, gently leaning on the person‚Äôs head and shoulder, creating an intimate, calm, emotional composition. Detailed natural environment background, soft light, emotional, nostalgic feeling, watercolor-like textures. All subjects looking directly into the camera lens.`,
                    details: 'Dibujo a mano, colores c√°lidos, fondo detallado de naturaleza, sensaci√≥n nost√°lgica.'
                },
                'cartoon_flat': {
                    name: 'Caricatura Estilizada (Cartoon) üì∫',
                    description: `modern cartoon style portrait with thick, clean outlines and flat colors, similar to popular adult animated sitcoms. A person and their dogs in an intimate pose, heads stacked, vibrant, highly stylized, minimal shading. All subjects looking directly into the camera lens.`,
                    details: 'Colores planos, contornos gruesos y limpios, look de caricatura moderna.'
                }
            };
            
            // --- DEFINICI√ìN DE STICKERS EMOCIONALES ---
            const groupStickerEmotions = [
                { name: 'Grupo Feliz', key: 'group-happy', prompt: 'happy and smiling, showing positive emotion.' },
                { name: 'Grupo Sorprendido', key: 'group-surprised', prompt: 'looking very surprised, with big open eyes and exaggerated expressions.' }
            ];

            const individualStickerEmotions = [
                { name: 'So√±oliento', key: 'sleepy', prompt: 'looking sleepy or tired, perhaps with small yawns or closed eyes.' },
                { name: 'Cari√±o', key: 'love', prompt: 'showing affection and love, maybe with a small heart icon or a gentle, loving look.' },
                { name: 'Gracioso', key: 'silly', prompt: 'looking silly and wacky, making funny or exaggerated faces.' },
                { name: 'Curioso', key: 'curious', prompt: 'looking curious, with head tilted slightly.' },
                { name: 'Enojado', key: 'angry', prompt: 'looking slightly annoyed or angry, with a furrowed brow.' }
            ];

            let selectedStyleKey = 'fine_art_bw'; 
            
            // --- CUSTOM ALERT ---
            function showAlert(message) {
                alertMessage.textContent = message;
                customAlert.classList.remove('hidden');
            }
            alertCloseBtn.addEventListener('click', () => customAlert.classList.add('hidden'));

            // --- L√ìGICA DE DRAG & DROP Y PREVIEWS (Unchanged) ---
            function setupDragDrop(dropArea, input, handleFiles) {
                dropArea.addEventListener('click', () => input.click());
                input.addEventListener('change', (e) => handleFiles(e.target.files));

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.add('drag-over'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.remove('drag-over'), false);
                });
                
                dropArea.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files), false);
            }
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function handleSelfieFile(files) {
                const file = files[0];
                if (file && file.type.startsWith('image/')) {
                    selfieFile = file;
                    selfiePreview.innerHTML = '';
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'preview-image';
                        selfiePreview.appendChild(img);
                        selfiePreviewContainer.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    showAlert("Por favor, sube un archivo de imagen v√°lido (JPG, PNG, WEBP).");
                }
            }
            
            function handleDogFiles(newFiles) {
                const validNewFiles = Array.from(newFiles).filter(file => file.type.startsWith('image/'));
                
                // Note: The input.files property doesn't reflect the combined set, 
                // so we manage dogFiles array manually based on if input.files was used (to replace)
                // or if we're adding (drag and drop/multiple selection).
                if (dogsInput.files.length === newFiles.length && dogsInput.files.length > 0) {
                    // This implies a full replacement (e.g., selecting via dialog)
                    dogFiles = validNewFiles;
                } else {
                    // Drag and drop or adding to an existing set
                    dogFiles = [...dogFiles, ...validNewFiles]; 
                }

                if(dogFiles.length > 0) {
                    dogPreviews.innerHTML = '';
                    dogFiles.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'preview-image';
                            dogPreviews.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    });
                    dogsPreviewsContainer.classList.remove('hidden');
                } else {
                     dogsPreviewsContainer.classList.add('hidden');
                }
                
                // Clear the input value to allow the 'change' event to fire again if the same file is selected
                dogsInput.value = '';

                if (newFiles.length > 0 && validNewFiles.length === 0) {
                     showAlert("Algunos archivos no eran im√°genes v√°lidas y han sido ignorados.");
                }
            }
            
            // --- L√ìGICA DE ESTILOS Y UI DIN√ÅMICA ---
            function populateStyleSelect() {
                let options = '';
                for (const key in styles) {
                    const style = styles[key];
                    options += `<option value="${key}">${style.name}</option>`;
                }
                styleSelect.innerHTML = options;
                updateStyleUI('fine_art_bw');
            }

            function updateStyleUI(key) {
                const style = styles[key];
                if (!style) return;
                
                selectedStyleKey = key;
                styleDetails.textContent = style.details;
            }

            styleSelect.addEventListener('change', (e) => {
                updateStyleUI(e.target.value);
            });


            // --- HELPER TO CONVERT FILE TO BASE64 ---
            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                });
            }

            // --- L√ìGICA DE MENSAJES DE CARGA ---
            const loadingMessages = {
                'portrait': [
                    { title: "üì∑ Analizando tus Fotos...", text: "Reconociendo los rostros y las texturas de pelaje para la semejanza exacta." },
                    { title: "üß† Dise√±ando la Composici√≥n...", text: "La IA est√° creando la composici√≥n de cabezas apiladas y asegurando que todos miren a c√°mara." },
                    { title: "‚ú® Aplicando el Estilo Art√≠stico...", text: `Pintando tu retrato final en el estilo {styleName}.` } 
                ],
                'sticker': [
                    { title: "‚ú® Preparando Estilo Caricatura...", text: "Simplificando los sujetos a un estilo *chibi* vibrante." },
                    { title: "‚úÇÔ∏è Generando Stickers Grupales...", text: "Creando stickers con la persona y todos los perros juntos." },
                    { title: "üöÄ Generando Stickers Individuales...", text: "Ahora, haciendo stickers para cada personaje por separado con emociones." },
                    { title: "‚úÖ Set de Stickers Listo...", text: "Todos tus stickers est√°n creados y listos para descargar." }
                ]
            };


            function updateLoadingMessage(mode, stepIndex, delay, customText = null) {
                clearLoadingMessages();
                const steps = loadingMessages[mode];
                
                let currentStepIndex = stepIndex;
                
                const update = () => {
                    let currentStep = { ...steps[currentStepIndex % steps.length] }; // Clone to modify
                    
                    if (customText) {
                        currentStep.text = customText;
                    } else if (mode === 'portrait' && currentStepIndex % steps.length === 2) {
                        currentStep.text = currentStep.text.replace('{styleName}', styles[selectedStyleKey].name);
                    }
                    
                    document.getElementById('message-title').textContent = currentStep.title;
                    document.getElementById('message-text').textContent = currentStep.text;
                    currentStepIndex++;
                };

                update();
                loadingInterval = setInterval(update, delay);
            }

            function clearLoadingMessages() {
                if (loadingInterval) {
                    clearInterval(loadingInterval);
                    loadingInterval = null;
                }
            }
            
            // Helper to make the API call with retries
            async function callNanoBanana(finalPrompt, imageParts, retries = 0) {
                 const MAX_RETRIES = 3;
                 while (retries < MAX_RETRIES) {
                    try {
                        const payload = {
                            contents: [{
                                parts: [{ text: finalPrompt }, ...imageParts]
                            }],
                            generationConfig: {
                                responseModalities: ['IMAGE']
                            },
                        };
                        
                        const apiKey = "";  
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                             // Retry on specific error codes
                            if (response.status === 429 || response.status >= 500) {
                                throw new Error('Retryable API Error');
                            }
                            throw new Error(errorData.error.message || 'La API devolvi√≥ un error inesperado.');
                        }

                        const result = await response.json();
                        const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                        
                        if (!base64Data) {
                              throw new Error('No se recibi√≥ una imagen en la respuesta de la API.');
                        }
                        
                        return `data:image/png;base64,${base64Data}`;

                    } catch(error) {
                        if (error.message === 'Retryable API Error' && retries < MAX_RETRIES - 1) {
                            retries++;
                            const delay = Math.pow(2, retries) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            throw error; // Re-throw fatal errors
                        }
                    }
                } // end while
                throw new Error('La solicitud fall√≥ despu√©s de varios intentos.');
            }

            // --- API & GENERATION LOGIC ---
            async function generateImage(isStickerGeneration = false) {
                if (!selfieFile || dogFiles.length === 0) {
                    showAlert('Por favor, sube tu selfie y al menos una foto de tu perro.');
                    return;
                }
                
                currentMode = isStickerGeneration ? 'sticker' : 'portrait';

                // 1. Gesti√≥n de estado inicial de botones y UI
                generateBtn.disabled = true;
                generateStickerBtn.disabled = true;
                regenerateBtn.disabled = true; 
                
                generateBtn.textContent = 'Generando...';
                if (isStickerGeneration) generateStickerBtn.textContent = 'Generando set de stickers...';
                
                resultCol.classList.add('hidden');
                messageCol.classList.remove('hidden');
                
                if (!isStickerGeneration) {
                    stickerList.innerHTML = `<p class="text-gray-500 text-sm italic col-span-full" id="sticker-placeholder">Haz clic en "Generar Stickers" para crear un set de pegatinas de tus personajes.</p>`;
                    stickerNote.classList.add('hidden');
                } else {
                    stickerList.innerHTML = ''; // Clear existing stickers
                    stickerPlaceholder.remove();
                }

                // Iniciar mensajes de progreso
                updateLoadingMessage(currentMode, 0, 4000); 

                try {
                    // 2. Convert all images to Base64 (needed for all generations)
                    const selfieBase64 = await fileToBase64(selfieFile);
                    const dogBase64Promises = dogFiles.map(file => fileToBase64(file));
                    const dogBase64s = await Promise.all(dogBase64Promises);
                    
                    let imageParts = [
                        { inlineData: { mimeType: selfieFile.type, data: selfieBase64 } },
                        ...dogBase64s.map((data, i) => ({
                            inlineData: { mimeType: dogFiles[i].type, data: data }
                        }))
                    ];

                    if (isStickerGeneration) {
                        // --- GENERACI√ìN DE STICKERS (GRUPALES E INDIVIDUALES) ---
                        let stickerResults = [];
                        
                        // Base prompt for stickers
                        const stickerBasePrompt = `chibi, cartoon-style digital sticker illustration. The image must have a thick white border, placed on a clean white background. High resolution, vibrant colors, vector-like quality.`;

                        // 2.1 Generate Group Stickers
                        updateLoadingMessage(currentMode, 1, 4000); 
                        for (let i = 0; i < groupStickerEmotions.length; i++) {
                            const emotion = groupStickerEmotions[i];
                            const prompt = `${stickerBasePrompt} Subjects: a person and one or more dogs, with their heads stacked one on top of the other, looking directly into the camera. Emotion: ${emotion.prompt}`;
                            
                            updateLoadingMessage(currentMode, 1, 4000, `Generando sticker grupal ${i + 1} de ${groupStickerEmotions.length}: ${emotion.name}...`);
                            const imageUrl = await callNanoBanana(prompt, imageParts);
                            stickerResults.push({ name: emotion.name, key: emotion.key, imageUrl });
                        }

                        // 2.2 Generate Individual Stickers
                        updateLoadingMessage(currentMode, 2, 4000); 

                        const allSubjects = [{ name: 'Persona', file: selfieFile, base64: selfieBase64, type: 'person' }];
                        dogFiles.forEach((file, index) => {
                            allSubjects.push({ name: `Perro ${index + 1}`, file: file, base64: dogBase64s[index], type: 'dog' });
                        });

                        for (let i = 0; i < allSubjects.length; i++) {
                            const subject = allSubjects[i];
                            const emotionIndex = i % individualStickerEmotions.length; // Cycle through emotions
                            const emotion = individualStickerEmotions[emotionIndex];

                            let individualImageParts = [{ inlineData: { mimeType: subject.file.type, data: subject.base64 } }];
                            let individualPrompt;

                            if (subject.type === 'person') {
                                individualPrompt = `${stickerBasePrompt} Subject: a person, looking directly into the camera. Emotion: ${emotion.prompt}`;
                            } else { // It's a dog
                                individualPrompt = `${stickerBasePrompt} Subject: a dog, looking directly into the camera. Emotion: ${emotion.prompt}`;
                            }
                            
                            updateLoadingMessage(currentMode, 2, 4000, `Generando sticker individual de ${subject.name} (${emotion.name})...`);
                            const imageUrl = await callNanoBanana(individualPrompt, individualImageParts);
                            stickerResults.push({ name: `${subject.name} ${emotion.name}`, key: `${subject.type}-${subject.name.replace(' ', '-').toLowerCase()}-${emotion.key}`, imageUrl });
                        }
                        
                        // Display all generated stickers
                        stickerList.innerHTML = stickerResults.map(s => `
                            <div class="sticker-container">
                                <p class="text-xs font-medium text-gray-700 mb-1 truncate">${s.name}</p>
                                <img src="${s.imageUrl}" alt="Sticker ${s.name}" class="rounded-lg shadow-md">
                                <button onclick="downloadSticker('${s.imageUrl}', '${s.key}')" class="text-xs mt-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-1 px-2 rounded-full w-full">
                                    Descargar
                                </button>
                            </div>
                        `).join('');

                        stickerNote.classList.remove('hidden');
                        document.getElementById('result-title').textContent = `üéâ ¬°Set de Stickers Listo (${stickerResults.length} stickers)!`;
                        showAlert(`¬°Tu set de ${stickerResults.length} stickers digitales est√° listo!`);
                        
                    } else {
                        // --- GENERACI√ìN DE RETRATO PRINCIPAL ---
                        const baseDescription = styles[selectedStyleKey].description;
                        const finalPrompt = baseDescription; 
                        
                        const imageUrl = await callNanoBanana(finalPrompt, imageParts);
                        
                        resultImage.src = imageUrl;
                        currentPortraitUrl = imageUrl;
                        document.getElementById('result-title').textContent = `üéâ ¬°Tu Retrato ${styles[selectedStyleKey].name} Est√° Listo!`;
                    }
                    
                    // 3. Finalizaci√≥n exitosa
                    clearLoadingMessages();
                    messageCol.classList.add('hidden');
                    resultCol.classList.remove('hidden');

                } catch(error) {
                    console.error("Fallo la generaci√≥n:", error);
                    showAlert(`Hubo un error al generar ${currentMode === 'sticker' ? 'tus stickers' : 'tu retrato'}: ${error.message.includes('Retryable') ? 'La solicitud fall√≥ despu√©s de varios intentos.' : error.message}. Por favor, int√©ntalo de nuevo.`);
                    
                    clearLoadingMessages();
                    // If portrait generation fails, revert to input state
                    if (currentMode === 'portrait') resetUI(); 
                }

                // 4. Resetear estado de botones
                generateBtn.disabled = false;
                generateBtn.textContent = 'üé® Crear Mi Retrato';
                generateStickerBtn.disabled = false; 
                generateStickerBtn.textContent = '‚ú® Generar Set de Stickers';
                regenerateBtn.disabled = false; 
            } // end generateImage
            
            // --- UI RESET ---
            function resetUI() {
                resultCol.classList.add('hidden');
                messageCol.classList.add('hidden');
                
                selfieFile = null;
                dogFiles = [];
                selfieInput.value = '';
                dogsInput.value = '';
                selfiePreview.innerHTML = '';
                dogPreviews.innerHTML = '';
                selfiePreviewContainer.classList.add('hidden');
                dogsPreviewsContainer.classList.add('hidden');
                stickerList.innerHTML = `<p class="text-gray-500 text-sm italic col-span-full" id="sticker-placeholder">Haz clic en "Generar Stickers" para crear un set de pegatinas de tus personajes.</p>`;
                stickerNote.classList.add('hidden');
                currentPortraitUrl = '';

                // Asegurar el estado del bot√≥n al resetear
                generateBtn.disabled = false;
                generateBtn.textContent = 'üé® Crear Mi Retrato';
                generateStickerBtn.disabled = false;
                generateStickerBtn.textContent = '‚ú® Generar Set de Stickers';
                
                clearLoadingMessages();
                currentMode = 'portrait';
            }

            // --- DOWNLOAD LOGIC ---
            function downloadPortrait() {
                if (!currentPortraitUrl) {
                     showAlert("No hay una imagen principal generada para descargar.");
                     return;
                }
                const a = document.createElement('a');
                a.href = currentPortraitUrl;
                a.download = `pet-portrait-ai-portrait-${selectedStyleKey}.png`; 
                document.body.appendChild(a); 
                a.click();
                document.body.removeChild(a);
                showAlert("¬°Tu retrato principal ha sido descargado! üéâ");
            }
            
            window.downloadSticker = function(imageUrl, key) {
                const a = document.createElement('a');
                a.href = imageUrl;
                a.download = `pet-portrait-ai-sticker-${key}.png`; 
                document.body.appendChild(a); 
                a.click();
                document.body.removeChild(a);
                // No alert here to avoid cluttering during mass download attempts
            }

            // --- INICIALIZACI√ìN ---
            setupDragDrop(selfieDropArea, selfieInput, handleSelfieFile);
            setupDragDrop(dogsDropArea, dogsInput, handleDogFiles);
            populateStyleSelect(); // Llenar el selector de estilos
            
            generateBtn.addEventListener('click', () => generateImage(false)); // Portrait
            generateStickerBtn.addEventListener('click', () => generateImage(true)); // Stickers
            startOverBtn.addEventListener('click', resetUI);
            downloadBtn.addEventListener('click', downloadPortrait);
            regenerateBtn.addEventListener('click', () => generateImage(false)); // Regenerate Portrait
            
            // Initial state button reset
             generateBtn.disabled = false;
             generateStickerBtn.disabled = false;
        });
    </script>
</body>
</html>
